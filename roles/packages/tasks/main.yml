---
- name: Install Packages
  ansible.builtin.package:
    name: "{{ item }}"
    state: latest
  loop: "{{ packages }}"

- name: Install the "C Development Tools and Libraries" Package Group
  ansible.builtin.dnf:
    name: '@C Development Tools and Libraries'
    state: present

- name: Install Ansible
  ansible.builtin.pip:
    name: ansible

# ----------------- Install NodeJS -----------------------

- name: Check for NVM Install Script
  ansible.builtin.stat:
    path: "{{ nvm_install_path }}/nvm.sh"
  register: nvm_sh

- name: Check for NPM
  ansible.builtin.stat:
    path: "{{ nvm_npm_path }}"
  register: npm_sh

- block:
  - name: Create .bashrc If Missing
    ansible.builtin.file:
      path: "{{ nvm_home }}/.bashrc"
      state: touch
      mode: 0644
      owner: "{{ primary_user }}"
      group: "{{ nvm_group }}"

  - name: Download NVM
    ansible.builtin.get_url:
      url: https://raw.githubusercontent.com/creationix/nvm/v0.32.1/install.sh
      dest: /tmp/install.sh
      mode: 0777

  - name: Set Owner of NVM Install Script
    ansible.builtin.file:
      path: /tmp/install.sh
      owner: "{{ primary_user }}"
      group: "{{ nvm_group }}"

  - name: Install NVM
    ansible.builtin.shell: /tmp/install.sh
    args:
      executable: /bin/bash
    environment:
      HOME: "{{ nvm_home }}"

  - name: Install Node.js and Set Defaults
    ansible.builtin.shell: ". {{ nvm_home }}/.nvm/nvm.sh && nvm install {{ nvm_node_version }} && nvm use {{ nvm_node_version }}"
    args:
      executable: /bin/bash
    environment:
      HOME: "{{ nvm_home }}"

  - name: Change .nvm Owner
    ansible.builtin.file:
      path: /home/{{ primary_user }}/.nvm
      state: directory
      recurse: yes
      owner: "{{ primary_user }}"
      group: "{{ primary_user }}"
  when: nvm_sh.stat.exists == False or npm_sh.stat.exists == False

#  --------------- Install Rust --------------------

- name: Check if Cargo is installed
  ansible.builtin.shell: command -v cargo
  register: cargo_exists
  ignore_errors: true

- block:
  - name: Download Rust Installer
    ansible.builtin.get_url:
      url: https://sh.rustup.rs
      dest: /tmp/sh.rustup.rs
      mode: '0755'
      force: 'yes'
    tags:
      - rust

  - name: Install Rust/Cargo
    ansible.builtin.shell: /tmp/sh.rustup.rs -y
    tags:
      - rust

  when: cargo_exists is failed